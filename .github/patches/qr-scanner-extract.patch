name: Apply QR scanner extract and push
on:
workflow_dispatch:
inputs:
target_branch:
description: 'Remote branch to overwrite (default: bot/qr-speed)'
required: false
default: 'bot/qr-speed'
backup_branch:
description: 'Remote backup branch name (default: bot/qr-speed-backup)'
required: false
default: 'bot/qr-speed-backup'
patch_path:
description: 'Path to patch file in the repo (default: .github/patches/qr-scanner-extract.patch)'
required: false
default: '.github/patches/qr-scanner-extract.patch'

jobs:
apply-and-push:
runs-on: ubuntu-latest
steps:
- name: Checkout repository (full history)
uses: actions/checkout@v4
with:
fetch-depth: 0

  - name: Show inputs
    run: |
      echo "target_branch=${{ github.event.inputs.target_branch }}"
      echo "backup_branch=${{ github.event.inputs.backup_branch }}"
      echo "patch_path=${{ github.event.inputs.patch_path }}"

  - name: Ensure git user
    run: |
      git config user.name "github-actions[bot]"
      git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

  - name: Create remote backup branch
    run: |
      TARGET="${{ github.event.inputs.target_branch }}"
      BACKUP="${{ github.event.inputs.backup_branch }}"
      # fetch remote branch if exists
      if git ls-remote --exit-code origin "refs/heads/$TARGET"; then
        git fetch origin $TARGET:$BACKUP || true
        echo "Created local backup branch $BACKUP from origin/$TARGET"
        git push origin $BACKUP || echo "Failed to push backup branch (may already exist)."
      else
        echo "origin/$TARGET does not exist; skipping backup."
      fi

  - name: Create working branch from master
    run: |
      git checkout -b pr/qr-scanner-extract origin/master

  - name: Apply patch from repo
    run: |
      PATCH_PATH="${{ github.event.inputs.patch_path }}"
      if [ ! -f "$PATCH_PATH" ]; then
        echo "Patch file not found at $PATCH_PATH"
        exit 1
      fi
      # Use git am to apply patch (keeps commit metadata)
      git am --3way "$PATCH_PATH" || { echo "git am failed, trying git apply + commit"; git reset --hard; git checkout -b pr/qr-scanner-extract origin/master; git apply "$PATCH_PATH" && git add . && git commit -m "apply patch: extract qr scanner (from workflow)"; }

  - name: Show new files added (quick sanity)
    run: |
      git --no-pager diff --name-status origin/master...HEAD | sed -n '1,200p'

  - name: Push pr/qr-scanner-extract to remote target (force)
    env:
      TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
    run: |
      # Force-push local pr/qr-scanner-extract to remote TARGET_BRANCH
      git push --force origin pr/qr-scanner-extract:refs/heads/"${TARGET_BRANCH}"

  - name: Create PR comment URL
    run: |
      echo "Branch pr/qr-scanner-extract pushed to origin/${{ github.event.inputs.target_branch }}."
      echo "Open a PR on GitHub to review changes or inspect the remote branch directly."
